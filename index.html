<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2196F3">
    <title>Elevation Finder</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="crosshair"></div>

    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 id="info-title">About Elevation Finder</h4>

            <p id="info-desc">This tool helps you analyze terrain to find highest points and calculate maximum ascent
                within a given area.<br>The application works on mobile devices, but is best experienced on larger
                screens.</p>

            <div
                style="text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px; color: #555;">

                <div id="info-section-peaks" style="font-weight: 700; color: #333; margin-top: 5px;">Find Highest Points
                </div>
                <ul style="padding-left: 20px; margin: 5px 0;">
                    <li id="info-help-radius">Radius: Set the size of the search area.</li>
                    <li id="info-help-points">Points: How many peaks to find.</li>
                    <li id="info-help-show-radius">Show Radius: Hide or show the blue circle.</li>
                    <li id="info-help-lock-radius">Lock Radius: Pin search to current pos.</li>
                </ul>

                <div id="info-section-climbs" style="font-weight: 700; color: #333; margin-top: 10px;">Find Climbs</div>
                <ul style="padding-left: 20px; margin: 5px 0;">
                    <li id="info-help-dist">Measure Dist: Max distance for ascent.</li>
                    <li id="info-help-climbs">Num Climbs: How many climbs to find.</li>
                </ul>

                <p id="info-results-desc"
                    style="margin-top:10px; font-style: italic; border-top: 1px solid #ddd; padding-top: 5px;">
                    Results show rank, elevation, distance and coordinates.
                </p>
            </div>

            <p><strong><span id="info-creator">Creator</span>:</strong> <a href="http://droidgren.github.io/"
                    target="_blank">droidgren.github.io</a></p>

            <p style="font-size: 12px; color: #666; margin-top: 5px; margin-bottom: 0;">
                <span id="lbl-version">Version</span>: <span id="app-version">1.3</span>
            </p>

            <details
                style="text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 12px; color: #555;">
                <summary style="font-weight: 700; color: #333; cursor: pointer; outline: none;"
                    id="info-changelog-title">Changelog</summary>
                <ul style="padding-left: 20px; margin: 8px 0 0 0; line-height: 1.5;">
                    <li><strong>v1.3:</strong> Made app installable (PWA), added custom numbered map pins, improved
                        touch UI for number inputs, and fixed alignment on high-res screens.</li>
                    <li><strong>v1.2.1:</strong> Fixed incorrect results at zoom level 15+. Added toggleable water
                        analysis in debug settings.</li>
                    <li><strong>v1.2:</strong> Migrated elevation tiles to Mapterhorn (512px resolution).</li>
                    <li><strong>v1.1:</strong> Added "Find Climbs" feature, Lantm√§teriet map, and multi-language
                        support.</li>
                    <li><strong>v1.0:</strong> Initial release.</li>
                </ul>
            </details>

            <p id="info-privacy"
                style="font-size: 12px; color: #888; border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px;">
                This application is fully client-side. No data saved on server.
            </p>

            <details
                style="text-align: left; background: #f0f0f0; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 12px; color: #777;">
                <summary style="font-weight: 600; color: #999; cursor: pointer; outline: none;" id="info-debug-title">
                    Debug settings</summary>
                <div style="margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="water-analysis-toggle">
                        <span id="lbl-water-analysis">Water analysis (filter water from results)</span>
                    </label>
                </div>
            </details>

            <button id="info-close" class="save-btn" onclick="closeInfo()">Close</button>
        </div>
    </div>

    <div id="key-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 id="modal-title">Enter API Key</h4>
            <p id="modal-text">...</p>
            <p><a id="modal-link" href="#" target="_blank">Register here</a></p>
            <input type="text" id="api-key-input" placeholder="...">
            <div class="modal-btns">
                <button id="modal-save" class="save-btn" onclick="saveApiKey()">Save</button>
                <button id="modal-cancel" class="cancel-btn" onclick="cancelApiKey()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="header-row">
            <h3 id="app-title">Elevation Finder</h3>
            <div class="header-buttons">
                <button class="circle-btn" onclick="toggleLanguage()" title="Switch Language">
                    <img id="flag-icon" class="flag-img" src="" alt="Flag">
                </button>
                <button class="circle-btn info-btn" onclick="showInfo()" title="Info">i</button>
                <button class="toggle-btn" onclick="toggleControls()" title="Minimize">‚ûñ</button>
            </div>
        </div>

        <div class="live-height-box">
            <span id="liveLabel" class="live-label">ELEVATION</span>
            <span id="center-h" class="live-value">-- m</span>
        </div>

        <div id="controls-content">

            <div style="margin-bottom: 10px;">
                <span id="lbl-layers" class="control-label" style="display:block; margin-bottom:3px;">Map Layer:</span>
                <div class="select-container">
                    <select id="layerSelect" onchange="handleLayerChange(this.value)">
                        <option value="opentopo" selected>OpenTopo</option>
                        <option value="tracetrack">Tracetrack Topo</option>
                        <option value="thunderforest">ThunderForest Outdoors</option>
                        <option value="lm_map">Lantm√§teriet (Sweden)</option>
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Satellite (ESRI)</option>
                        <option value="debug">Elevation Data (Debug)</option>
                    </select>
                    <button id="edit-key-btn" class="icon-btn" onclick="openCurrentKeyModal()" title="API"
                        style="display:none;">üîë</button>
                </div>
            </div>

            <div class="search-group">
                <input type="text" id="searchInput" placeholder="Search location">
                <button class="icon-btn" onclick="locateUser()" title="GPS">üìç</button>
                <button class="icon-btn" onclick="searchLocation()" title="Search">üîç</button>
            </div>

            <hr style="border:0; border-top:1px solid #eee; width:100%; margin: 5px 0;">

            <div class="control-row">
                <span id="lbl-radius" class="control-label">Search Radius (km):</span>
                <div class="number-input-group">
                    <button class="num-btn" onclick="adjustNumber('radiusInput', -0.5)">-</button>
                    <input type="number" id="radiusInput" value="1" min="0.5" max="100" step="0.5">
                    <button class="num-btn" onclick="adjustNumber('radiusInput', 0.5)">+</button>
                </div>
            </div>

            <div class="control-row">
                <span id="lbl-points" class="control-label">Num Points:</span>
                <div class="number-input-group">
                    <button class="num-btn" onclick="adjustNumber('numPoints', -1)">-</button>
                    <input type="number" id="numPoints" value="3" min="1" max="50">
                    <button class="num-btn" onclick="adjustNumber('numPoints', 1)">+</button>
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-row">
                    <input type="checkbox" id="show-circle" checked>
                    <label id="lbl-show-circle" for="show-circle">Show Radius</label>
                </div>

                <div class="checkbox-row">
                    <input type="checkbox" id="lock-circle">
                    <label id="lbl-lock-circle" for="lock-circle" title="Lock">üîí Lock Radius</label>
                </div>
            </div>

            <button id="scan-btn" class="action-btn" onclick="analyzeTerrain()" disabled>üìç Find Highest Points</button>

            <hr style="border:0; border-top:1px solid #eee; width:100%; margin: 10px 0;">

            <div class="control-row">
                <span id="lbl-climb-dist" class="control-label">Measure Dist. (m):</span>
                <div class="number-input-group">
                    <button class="num-btn" onclick="adjustNumber('climbDistInput', -10)">-</button>
                    <input type="number" id="climbDistInput" value="200" min="50" max="5000" step="10">
                    <button class="num-btn" onclick="adjustNumber('climbDistInput', 10)">+</button>
                </div>
            </div>

            <div class="control-row">
                <span id="lbl-num-climbs" class="control-label">Num Climbs:</span>
                <div class="number-input-group">
                    <button class="num-btn" onclick="adjustNumber('numClimbsInput', -1)">-</button>
                    <input type="number" id="numClimbsInput" value="1" min="1" max="10">
                    <button class="num-btn" onclick="adjustNumber('numClimbsInput', 1)">+</button>
                </div>
            </div>

            <button id="climb-btn" class="climb-btn" onclick="findSteepestClimb()" disabled>üìà Find Climbs</button>

            <button id="clear-btn" class="clear-btn" onclick="clearResults()">üóëÔ∏è Clear Results</button>

            <div class="footer-row">
                <div id="status">Ready.</div>
                <span id="zoom-level" class="zoom-badge">Zoom: 11</span>
            </div>
        </div>
    </div>

    <canvas id="analysis-canvas"></canvas>
    <canvas id="single-point-canvas" width="1" height="1"></canvas>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="script.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('ServiceWorker registered'))
                    .catch(error => console.log('ServiceWorker registration failed:', error));
            });
        }
    </script>
</body>

</html>